# ============================================================================
# YTFY Nginx Security Configuration - Maps & Geo
# ============================================================================
# This file contains ONLY http-level directives (maps, geo).
# It is included automatically via conf.d/*.conf in the http block.
# Location blocks must be placed in server blocks or included separately.
# ============================================================================

# ==========================================================================
# Content Security Policy (CSP) Map
# ==========================================================================
map $uri $csp_header {
    default "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://accounts.google.com https://apis.google.com blob:; style-src 'self' 'unsafe-inline'; img-src 'self' data: https: blob:; media-src 'self' blob: https://*.googlevideo.com https://*.youtube.com https://*.invidious.io https://inv.nadeko.net https://invidious.nerdvpn.de https://invidious.private.coffee https://invidious.protokolla.fi https://iv.melmac.space https://*.zeabur.app https://invidious.f5.si https://y.com.sb https://inv.vern.cc https://invidious.darkness.services https://invidious.reallyaweso.me https://yt.omada.cafe https://invidious.materialio.us; connect-src 'self' https://accounts.google.com https://www.googleapis.com https://oauth2.googleapis.com https://*.googlevideo.com https://*.youtube.com https://*.ytimg.com https://*.invidious.io https://*.piped.video https://rapid-email-verifier.fly.dev https://uma.instinct.rip https://raw.githubusercontent.com https://*.vercel.app https://inv.nadeko.net https://invidious.nerdvpn.de https://invidious.private.coffee https://invidious.protokolla.fi https://iv.melmac.space https://*.zeabur.app https://invidious.f5.si https://y.com.sb https://inv.vern.cc https://invidious.darkness.services https://invidious.reallyaweso.me https://yt.omada.cafe https://invidious.materialio.us wss:; font-src 'self' data:; frame-src 'self' https://accounts.google.com; frame-ancestors 'self'; base-uri 'self'; form-action 'self'; worker-src 'self' blob:;";
}

# ==========================================================================
# Request Filtering
# ==========================================================================
map $http_user_agent $blocked_agent {
    default 0;
    ~*(?:curl|wget|python|java|perl|ruby|php|scrapy|scanner|nikto|sqlmap) 0;  # Allow legitimate tools for now
    ~*(?:bot|crawler|spider) 0;  # Allow search bots
    "" 1;  # Block empty user agents
}

map $request_method $blocked_method {
    default 0;
    ~*(?:TRACE|TRACK) 1;
}

# ==========================================================================
# IP-based Access Control
# ==========================================================================
geo $admin_allowed {
    default 0;
    127.0.0.1 1;
    ::1 1;
    10.0.0.0/8 1;
    172.16.0.0/12 1;
    192.168.0.0/16 1;
}

# ==========================================================================
# CORS Configuration
# ==========================================================================
map $http_origin $cors_origin {
    default "";
    ~^https?://(music\.ml4-lab\.com|ytify\.nicesrv\.de|localhost:\d+)$ $http_origin;
}

# ==========================================================================
# Bot Protection
# ==========================================================================
map $http_user_agent $is_crawler {
    default 0;
    ~*(?:googlebot|bingbot|slurp|duckduckbot|yandexbot|sogou|exabot|facebot|ia_archiver) 1;
}

# Rate limit customization
limit_req_status 429;
limit_conn_status 429;
limit_req_log_level warn;
limit_conn_log_level warn;
